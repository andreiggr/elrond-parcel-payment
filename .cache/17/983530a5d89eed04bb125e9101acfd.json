{"id":"node_modules/@elrondnetwork/erdjs/out/dapp/hwProvider.js","dependencies":[{"name":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/dapp/hwProvider.js.map","includedInParent":true,"mtime":1647170305009},{"name":"/Users/mac/code/work/bitmarket/elrond-parcel/package.json","includedInParent":true,"mtime":1647174146392},{"name":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/package.json","includedInParent":true,"mtime":1647170304850},{"name":"@ledgerhq/hw-transport-u2f","loc":{"line":16,"column":51,"index":977},"parent":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/dapp/hwProvider.js","resolved":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@ledgerhq/hw-transport-u2f/lib-es/TransportU2F.js"},{"name":"@ledgerhq/hw-transport-webusb","loc":{"line":17,"column":54,"index":1063},"parent":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/dapp/hwProvider.js","resolved":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@ledgerhq/hw-transport-webusb/lib-es/TransportWebUSB.js"},{"name":"@elrondnetwork/hw-app-elrond","loc":{"line":19,"column":48,"index":1160},"parent":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/dapp/hwProvider.js","resolved":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/hw-app-elrond/lib-es/Elrond.js"},{"name":"platform","loc":{"line":20,"column":43,"index":1237},"parent":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/dapp/hwProvider.js","resolved":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/platform/platform.js"},{"name":"../address","loc":{"line":21,"column":26,"index":1277},"parent":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/dapp/hwProvider.js","resolved":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/address.js"},{"name":"../signature","loc":{"line":22,"column":28,"index":1320},"parent":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/dapp/hwProvider.js","resolved":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/signature.js"},{"name":"../versioning","loc":{"line":23,"column":29,"index":1366},"parent":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/dapp/hwProvider.js","resolved":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/versioning.js"},{"name":"./constants","loc":{"line":24,"column":28,"index":1412},"parent":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/dapp/hwProvider.js","resolved":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/dapp/constants.js"},{"name":"../networkParams","loc":{"line":25,"column":32,"index":1460},"parent":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/dapp/hwProvider.js","resolved":"/Users/mac/code/work/bitmarket/elrond-parcel/node_modules/@elrondnetwork/erdjs/out/networkParams.js"}],"generated":{"js":"\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.HWProvider = void 0;\nconst hw_transport_u2f_1 = __importDefault(require(\"@ledgerhq/hw-transport-u2f\"));\nconst hw_transport_webusb_1 = __importDefault(require(\"@ledgerhq/hw-transport-webusb\"));\n// @ts-ignore\nconst hw_app_elrond_1 = __importDefault(require(\"@elrondnetwork/hw-app-elrond\"));\nconst platform_1 = __importDefault(require(\"platform\"));\nconst address_1 = require(\"../address\");\nconst signature_1 = require(\"../signature\");\nconst versioning_1 = require(\"../versioning\");\nconst constants_1 = require(\"./constants\");\nconst networkParams_1 = require(\"../networkParams\");\nclass HWProvider {\n    constructor(httpProvider) {\n        this.addressIndex = 0;\n        this.provider = httpProvider;\n    }\n    /**\n     * Creates transport and initialises ledger app.\n     */\n    init() {\n        return __awaiter(this, void 0, void 0, function* () {\n            try {\n                let webUSBSupported = yield hw_transport_webusb_1.default.isSupported();\n                webUSBSupported =\n                    webUSBSupported && !!platform_1.default.os && platform_1.default.os.family !== \"Windows\" && platform_1.default.name !== \"Opera\";\n                const transport = webUSBSupported ? yield hw_transport_webusb_1.default.create() : yield hw_transport_u2f_1.default.create();\n                this.hwApp = new hw_app_elrond_1.default(transport);\n                return true;\n            }\n            catch (error) {\n                return false;\n            }\n        });\n    }\n    /**\n     * Returns true if init() was previously called successfully\n     */\n    isInitialized() {\n        return !!this.hwApp;\n    }\n    /**\n     * Mocked function, returns isInitialized as an async function\n     */\n    isConnected() {\n        return new Promise((resolve, _) => resolve(this.isInitialized()));\n    }\n    /**\n     * Performs a login request by setting the selected index in Ledger and returning that address\n     */\n    login(options) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            if (options && options.addressIndex) {\n                this.addressIndex = options.addressIndex;\n            }\n            yield this.hwApp.setAddress(0, this.addressIndex);\n            const { address } = yield this.hwApp.getAddress(0, this.addressIndex, true);\n            return address;\n        });\n    }\n    getAccounts(page = 0, pageSize = 10) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            const addresses = [];\n            const startIndex = page * pageSize;\n            for (let index = startIndex; index < startIndex + pageSize; index++) {\n                const { address } = yield this.hwApp.getAddress(0, index);\n                addresses.push(address);\n            }\n            return addresses;\n        });\n    }\n    /**\n     * Mocks a logout request by returning true\n     */\n    logout() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            return true;\n        });\n    }\n    /**\n     * Fetches current selected ledger address\n     */\n    getAddress() {\n        return __awaiter(this, void 0, void 0, function* () {\n            return this.getCurrentAddress();\n        });\n    }\n    /**\n     * Signs and sends a transaction. Returns the transaction hash\n     * @param transaction\n     */\n    sendTransaction(transaction) {\n        return __awaiter(this, void 0, void 0, function* () {\n            transaction = yield this.signTransaction(transaction);\n            yield transaction.send(this.provider);\n            return transaction;\n        });\n    }\n    signTransaction(transaction) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            const address = yield this.getCurrentAddress();\n            let signUsingHash = yield this.shouldSignUsingHash();\n            if (signUsingHash) {\n                transaction.options = networkParams_1.TransactionOptions.withTxHashSignOptions();\n                transaction.version = networkParams_1.TransactionVersion.withTxHashSignVersion();\n            }\n            const sig = yield this.hwApp.signTransaction(transaction.serializeForSigning(new address_1.Address(address)), signUsingHash);\n            transaction.applySignature(new signature_1.Signature(sig), new address_1.Address(address));\n            return transaction;\n        });\n    }\n    signTransactions(transactions) {\n        return __awaiter(this, void 0, void 0, function* () {\n            let retTx = [];\n            for (let tx of transactions) {\n                retTx.push(yield this.signTransaction(tx));\n            }\n            return retTx;\n        });\n    }\n    signMessage(message) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            const signature = yield this.hwApp.signMessage(message.serializeForSigningRaw());\n            message.applySignature(new signature_1.Signature(signature));\n            return message;\n        });\n    }\n    tokenLogin(options) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            if (options && options.addressIndex) {\n                this.addressIndex = options.addressIndex;\n            }\n            yield this.hwApp.setAddress(0, this.addressIndex);\n            const { signature, address } = yield this.hwApp.getAddressAndSignAuthToken(0, this.addressIndex, options.token);\n            return {\n                signature: new signature_1.Signature(signature),\n                address\n            };\n        });\n    }\n    shouldSignUsingHash() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            const config = yield this.hwApp.getAppConfiguration();\n            let diff = versioning_1.compareVersions(config.version, constants_1.LEDGER_TX_HASH_SIGN_MIN_VERSION);\n            return diff >= 0;\n        });\n    }\n    getCurrentAddress() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.hwApp) {\n                throw new Error(\"HWApp not initialised, call init() first\");\n            }\n            const { address } = yield this.hwApp.getAddress(0, this.addressIndex);\n            return address;\n        });\n    }\n}\nexports.HWProvider = HWProvider;\n"},"sourceMaps":{"js":{"version":3,"file":"hwProvider.js","sourceRoot":"","sources":["../../src/dapp/hwProvider.ts"],"names":[],"mappings":"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","sourcesContent":[null]}},"error":null,"hash":"422ecebc253ece1ef1645b7406a8e25f","cacheData":{"env":{}}}